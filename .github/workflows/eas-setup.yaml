name: EAS Setup (One-Time)

on:
  push:
    branches: [feature/eas-setup-workflow]
    paths:
      - ".github/workflows/eas-setup.yaml"

jobs:
  setup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Configure EAS Update
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          cd client
          eas update:configure --non-interactive || eas project:init --non-interactive
          
          # Extract and display the project ID
          PROJECT_ID=$(grep -oP '"projectId":\s*"\K[^"]+' ../app.json || echo "not found")
          echo "## EAS Project ID" >> $GITHUB_STEP_SUMMARY
          echo "\`$PROJECT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Update URL format:**" >> $GITHUB_STEP_SUMMARY
          echo "\`exp://u.expo.dev/$PROJECT_ID?channel-name=preview\`" >> $GITHUB_STEP_SUMMARY

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add app.json eas.json
            git commit -m "chore: configure EAS Update"
            git push
          fi
