name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: OpenAI Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff
        id: diff
        run: |
          # Get the diff and save to file
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- '*.ts' '*.tsx' '*.js' '*.jsx' | head -500 > /tmp/diff.txt
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | head -20 > /tmp/files.txt
          
          # Check if there are changes
          if [ -s /tmp/diff.txt ]; then
            echo "has_diff=true" >> $GITHUB_OUTPUT
          else
            echo "has_diff=false" >> $GITHUB_OUTPUT
          fi

      - name: AI Review
        if: steps.diff.outputs.has_diff == 'true' && env.OPENAI_API_KEY != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          FILES=$(cat /tmp/files.txt)
          DIFF=$(cat /tmp/diff.txt | head -c 8000)
          
          # Prepare the request
          REQUEST=$(jq -n \
            --arg diff "$DIFF" \
            --arg files "$FILES" \
            '{
              model: "gpt-4o",
              messages: [
                {
                  role: "system",
                  content: "You are a senior code reviewer for a React Native/Expo mobile app (Squad Party - a party games app). Review the diff for bugs, security issues, performance concerns, React best practices, and TypeScript type safety. Be concise. Only mention significant issues. If the code looks good, say so briefly. Format as markdown."
                },
                {
                  role: "user",
                  content: ("Review this PR diff:\n\nChanged files:\n" + $files + "\n\nDiff:\n```diff\n" + $diff + "\n```")
                }
              ],
              max_tokens: 1000,
              temperature: 0.3
            }')
          
          # Call OpenAI API
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$REQUEST")
          
          # Extract review content
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "Unable to generate review"')
          
          # Post comment to PR
          COMMENT="## ðŸ¤– AI Code Review

          $REVIEW

          ---
          *Powered by OpenAI GPT-4o*"
          
          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"
